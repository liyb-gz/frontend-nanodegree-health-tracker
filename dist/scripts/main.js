"use strict";var app=app||{};!function(t){t.SearchedFood=Backbone.Model.extend({defaults:{foodName:"",brandName:"",unitCalories:0,unitCarbo:0,unitFat:0,unitProtein:0,servingQty:1,servingUnit:"serving"}})}(app);var app=app||{};!function(t){t.RecordedFood=t.SearchedFood.extend({defaults:_.extend({},t.SearchedFood.prototype.defaults,{totalCalories:0,totalCarbo:0,totalFat:0,totalProtein:0,servingNumber:1}),initialize:function(){_.bindAll(this,"changeServing","recalculateNutrition"),this.on("change:servingNumber",this.changeServing),this.recalculateNutrition()},changeServing:function(){this.recalculateNutrition()},recalculateNutrition:function(){this.set({totalCalories:this.round(this.get("unitCalories")*this.get("servingNumber")),totalCarbo:this.round(this.get("unitCarbo")*this.get("servingNumber")),totalFat:this.round(this.get("unitFat")*this.get("servingNumber")),totalProtein:this.round(this.get("unitProtein")*this.get("servingNumber"))})},round:function(t){return Math.round(100*t)/100}})}(app);var app=app||{};!function(t){t.NutritionGoals=Backbone.Model.extend({defaults:{calories:2080,carbo:310,fat:70,protein:50,id:0},localStorage:new Backbone.LocalStorage("nutrition-goals")}),t.nutritionGoals=new t.NutritionGoals}(app);var app=app||{};!function(t){t.SearchedCollection=Backbone.Collection.extend({model:t.SearchedFood}),t.searchedCollection=new t.SearchedCollection}(app);var app=app||{};!function(t){t.RecordedCollection=Backbone.Collection.extend({model:t.RecordedFood,localStorage:new Backbone.LocalStorage("food-records"),initialize:function(){_.bindAll(this,"updateSumNutrition"),this.sumNutrition={sumCalories:0,sumCarbo:0,sumFat:0,sumProtein:0},this.on("change:servingNumber update",this.updateSumNutrition),this.fetch(),this.updateSumNutrition()},updateSumNutrition:function(){var t={sumCalories:0,sumCarbo:0,sumFat:0,sumProtein:0};this.models.forEach(function(e){t.sumCalories+=e.get("totalCalories"),t.sumCarbo+=e.get("totalCarbo"),t.sumFat+=e.get("totalFat"),t.sumProtein+=e.get("totalProtein")}),this.sumNutrition=t,this.trigger("updateSum")}}),t.recordedCollection=new t.RecordedCollection}(app);var app=app||{};!function(t){t.SearchedFoodView=Backbone.View.extend({tagName:"div",className:"panel panel-default food-item",template:_.template($("#searched-food-item-template").html()),events:{"click .btn-add":"addToRecord","click .btn-detail":"toggleDetails"},initialize:function(){_.bindAll(this,"render","addToRecord","toggleDetails"),this.listenTo(this.model,"destroy",this.remove),this.render()},render:function(){return this.$el.html(this.template(this.model.attributes)),this},addToRecord:function(){t.recordedCollection.create(new t.RecordedFood(this.model.attributes))},toggleDetails:function(){this.$(".nutrition-facts").toggle("fast"),this.$(".btn-detail").find(".glyphicon").toggleClass("glyphicon-resize-full glyphicon-resize-small")}})}(app);var app=app||{};!function(t){t.RecordedFoodView=Backbone.View.extend({tagName:"div",className:"panel panel-default food-item",template:_.template($("#recorded-food-item-template").html()),events:{"click .btn-detail":"toggleDetails","click .btn-edit":"edit","click .btn-drop":"drop","click .btn-submit":"submit","click .btn-cancel":"cancel","keyup input":"keyHandler"},initialize:function(t){_.bindAll(this,"render","getRenderParams","getGraphPercentages","toggleDetails","edit","drop","submit","cancel","endEdit","keyHandler"),this.nutritionGoals=t.nutritionGoals,this.hundredPercentLine=t.hundredPercentLine||80,this.editing=!1,this.showingDetails=!1,this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change",this.render),this.listenTo(this.nutritionGoals,"change",this.render),this.render()},render:function(){return this.$el.html(this.template(this.getRenderParams())),this},getRenderParams:function(){var t=_.extend({},this.model.attributes,{showingDetails:this.showingDetails},this.getGraphPercentages(this.hundredPercentLine));return t},getGraphPercentages:function(t){return{hundredPercentLine:t,carboPercentage:this.model.get("totalCarbo")/this.nutritionGoals.get("carbo")*t,fatPercentage:this.model.get("totalFat")/this.nutritionGoals.get("fat")*t,proteinPercentage:this.model.get("totalProtein")/this.nutritionGoals.get("protein")*t}},toggleDetails:function(){this.showingDetails=!this.showingDetails,this.$(".nutrition-facts").toggle("fast"),this.$(".btn-detail").find(".glyphicon").toggleClass("glyphicon-resize-full glyphicon-resize-small")},edit:function(){this.editing=!0,this.$(".btn-submit, .btn-cancel").show(),this.$(".btn-drop, .btn-edit").hide(),this.$(".food-name input").show().val(this.model.get("foodName")),this.$(".food-name span").hide(),this.$(".calories input").show().val(this.model.get("servingNumber")),this.$(".calories span").hide(),this.$("input").first().focus()},drop:function(){this.model.destroy()},submit:function(){this.model.save({foodName:this.$(".food-name input").val().trim(),servingNumber:parseFloat(this.$(".calories input").val())}),this.endEdit()},cancel:function(){this.endEdit()},endEdit:function(){this.editing=!1,this.$(".btn-submit, .btn-cancel").hide(),this.$(".btn-drop, .btn-edit").show(),this.$(".food-name input").hide(),this.$(".food-name span").show(),this.$(".calories input").hide(),this.$(".calories span").show()},keyHandler:function(t){t.which===ENTER_KEY&&this.submit()}})}(app);var app=app||{};!function(t){t.SearchedCollectionView=Backbone.View.extend({el:".search",events:{"mouseover .search-form":"focusOnSearch","keyup .search-form":"newSearch","click .btn-loadmore":"loadMore","click .btn-clear":"reset"},initialize:function(){_.bindAll(this,"render","addOne","focusOnSearch","toggleLoading","toggleLoadMoreBtn","setTotal","getTotal","clearAll","reset","getSearchURL","getSearchedFoodModel","newSearch","loadedSearch","loadMore","sendAjaxRequest","isAbleLoadMore"),this.$list=this.$(".search-results-items"),this.$loadingBar=this.$(".loading"),this.$noResultBar=this.$(".no-result"),this.$searchResultsNumber=this.$(".search-results-number"),this.$loadMoreBtn=this.$(".btn-loadmore"),this.$clearBtn=this.$(".btn-clear"),this.$form=this.$(".search-form"),this.$searchBar=this.$(".search-form input"),this.searchKeyword="",this.ajaxRequest=void 0,this.setTotal(0),this.$form.submit(function(t){t.preventDefault()}),this.on("change:ajaxTotal",this.changeTotal),this.on("loadedSearch",this.loadedSearch),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"update",this.render),this.collection.each(function(e){var i=new t.SearchedFoodView({model:e});this.$list.append(i.render().el)},this),this.render()},render:function(){0===this.collection.length?(this.$loadMoreBtn.hide("fast"),this.$clearBtn.prop("disabled",!0)):this.$clearBtn.prop("disabled",!1)},addOne:function(e){var i=new t.SearchedFoodView({model:e});this.$list.append(i.render().el)},focusOnSearch:function(){this.$searchBar.focus()},toggleLoading:function(t,e){switch(e=e||"fast",t){case"load":this.$loadingBar.show(e),this.$list.hide(e);break;case"show":this.$list.show(e),this.$loadingBar.hide(e);break;default:this.$list.toggle(e),this.$loadingBar.toggle(e)}},toggleLoadMoreBtn:function(t,e){switch(e=e||"fast",t){case"load":this.$loadMoreBtn.find(".done").hide(e),this.$loadMoreBtn.find(".loading").show(e);break;case"show":this.$loadMoreBtn.find(".done").show(e),this.$loadMoreBtn.find(".loading").hide(e);break;default:this.$loadMoreBtn.find(".done").toggle(e),this.$loadMoreBtn.find(".loading").toggle(e)}},setTotal:function(t){this.ajaxTotal=t,this.trigger("change:ajaxTotal")},getTotal:function(){return this.ajaxTotal},changeTotal:function(){this.getTotal()>0?this.$searchResultsNumber.show("fast").find(".number").html(this.getTotal()):this.$searchResultsNumber.hide("fast")},clearAll:function(){_.each(_.clone(this.collection.models),function(t){t.destroy()})},reset:function(){this.clearAll(),this.$searchResultsNumber.hide("fast"),this.$searchBar.val("")},getSearchURL:function(){var t="https://api.nutritionix.com/v1_1/search/",e="&fields=item_name,brand_name,item_id,nf_calories,nf_total_carbohydrate,nf_total_fat,nf_protein,nf_serving_size_qty,nf_serving_size_unit,nf_serving_weight_grams",i=this.collection.length+":"+(this.collection.length+20),n="8a3b278b",o="c2b176dfe053caed76d3baea5818c350";return t+this.searchKeyword+"?results="+i+e+"&appId="+n+"&appKey="+o},getSearchedFoodModel:function(t){var e={foodName:t.fields.item_name,brandName:t.fields.brand_name,unitCalories:t.fields.nf_calories,unitCarbo:t.fields.nf_total_carbohydrate,unitFat:t.fields.nf_total_fat,unitProtein:t.fields.nf_protein,servingQty:t.fields.nf_serving_size_qty,servingUnit:t.fields.nf_serving_size_unit};return e},newSearch:function(t){t.which===ENTER_KEY&&(this.searchKeyword=this.$searchBar.val(),this.$searchBar.blur(),this.clearAll(),this.toggleLoading("load"),this.sendAjaxRequest())},loadMore:function(){this.toggleLoadMoreBtn("load"),this.sendAjaxRequest()},loadedSearch:function(){var t=this;this.setTotal(this.ajaxRequest.responseJSON.total_hits),this.ajaxRequest.responseJSON.hits.forEach(function(e){t.collection.add(t.getSearchedFoodModel(e))}),this.toggleLoading("show"),this.toggleLoadMoreBtn("show"),0===this.collection.length?this.$noResultBar.show("fast"):this.$noResultBar.hide("fast"),this.isAbleLoadMore()?(this.$list.append(this.$loadMoreBtn),this.$loadMoreBtn.show("fast")):this.$loadMoreBtn.hide("fast")},sendAjaxRequest:function(){var t=this;this.ajaxRequest&&this.ajaxRequest.abort(),this.ajaxRequest=$.getJSON(this.getSearchURL(),function(){t.trigger("loadedSearch")}).fail(function(e,i){"abort"!==i&&(alert("Search result failed to load."),t.setTotal(0))})},isAbleLoadMore:function(){return this.collection.length<this.getTotal()}})}(app);var app=app||{};!function(t){t.RecordedCollectionView=Backbone.View.extend({el:".food-list",initialize:function(){_.bindAll(this,"render","addOne"),this.nutritionGoals=t.nutritionGoals,this.listenTo(this.collection,"add",this.addOne),this.render()},render:function(){this.collection.each(this.addOne)},addOne:function(e){var i=this,n=new t.RecordedFoodView({model:e,nutritionGoals:i.nutritionGoals});this.$el.append(n.render().el)}})}(app);var app=app||{};!function(t){t.NutritionGoalsView=Backbone.View.extend({el:".stats",events:{"click .btn-edit":"edit","click .btn-submit":"submit","click .btn-cancel":"cancel","keyup .goals-edit input":"keyHandler"},initialize:function(e){_.bindAll(this,"render","getGraphPercentages","edit","submit","cancel","endEdit","round","keyHandler"),e=e||{},this.hundredPercentLine=e.hundredPercentLine||80,this.recordedCollection=t.recordedCollection,this.$nutritionFacts=this.$(".nutrition-facts"),this.$editBtn=this.$(".btn-edit"),this.$submitBtn=this.$(".btn-submit"),this.$cancelBtn=this.$(".btn-cancel"),this.$caloriesBar=this.$nutritionFacts.find(".calories .progress-bar"),this.$carboBar=this.$nutritionFacts.find(".carbo .progress-bar"),this.$fatBar=this.$nutritionFacts.find(".fat .progress-bar"),this.$proteinBar=this.$nutritionFacts.find(".protein .progress-bar"),this.listenTo(this.recordedCollection,"updateSum",this.render),this.listenTo(this.model,"change",this.render),this.model.fetch(),this.$(".bar-step").attr("style","padding-left: "+this.hundredPercentLine+"%"),this.render()},render:function(){var t=this.getGraphPercentages(this.hundredPercentLine);this.$caloriesBar.width(t.caloriesPercentage+"%").find(".quantity").html(this.round(this.recordedCollection.sumNutrition.sumCalories)),this.$carboBar.width(t.carboPercentage+"%").find(".quantity").html(this.round(this.recordedCollection.sumNutrition.sumCarbo)),this.$fatBar.width(t.fatPercentage+"%").find(".quantity").html(this.round(this.recordedCollection.sumNutrition.sumFat)),this.$proteinBar.width(t.proteinPercentage+"%").find(".quantity").html(this.round(this.recordedCollection.sumNutrition.sumProtein))},getGraphPercentages:function(t){return{caloriesPercentage:this.recordedCollection.sumNutrition.sumCalories/this.model.get("calories")*t,carboPercentage:this.recordedCollection.sumNutrition.sumCarbo/this.model.get("carbo")*t,fatPercentage:this.recordedCollection.sumNutrition.sumFat/this.model.get("fat")*t,proteinPercentage:this.recordedCollection.sumNutrition.sumProtein/this.model.get("protein")*t}},edit:function(){this.$nutritionFacts.find(".progress").hide(),this.$nutritionFacts.find(".goals-edit").show(),this.$editBtn.hide(),this.$cancelBtn.show(),this.$submitBtn.show(),this.$(".calories input").val(this.model.get("calories")),this.$(".carbo input").val(this.model.get("carbo")),this.$(".fat input").val(this.model.get("fat")),this.$(".protein input").val(this.model.get("protein"))},submit:function(){this.model.save({calories:this.$(".calories input").val().trim()||this.model.get("calories"),carbo:this.$(".carbo input").val().trim()||this.model.get("carbo"),fat:this.$(".fat input").val().trim()||this.model.get("fat"),protein:this.$(".protein input").val().trim()||this.model.get("protein")}),this.endEdit()},cancel:function(){this.endEdit()},endEdit:function(){this.$nutritionFacts.find(".progress").show(),this.$nutritionFacts.find(".goals-edit").hide(),this.$editBtn.show(),this.$cancelBtn.hide(),this.$submitBtn.hide()},round:function(t){return Math.round(100*t)/100},keyHandler:function(t){t.which===ENTER_KEY&&this.submit()}})}(app);var ENTER_KEY=13,app=app||{};!function(t){$(function(){t.nutritionGoalsView=new t.NutritionGoalsView({model:t.nutritionGoals}),t.searchedCollectionView=new t.SearchedCollectionView({collection:t.searchedCollection}),t.recordedCollectionView=new t.RecordedCollectionView({collection:t.recordedCollection})})}(app);